@using SmallEBot.Models
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">@(IsEdit ? "Edit MCP service" : "Add MCP service")</MudText>
    </TitleContent>
    <DialogContent>
        <div class="d-flex flex-column gap-3">
            <MudTextField @bind-Value="_name" Label="Name" Variant="Variant.Outlined" Placeholder="Enter service name" Required="true" RequiredError="Please enter service name" />

            <div>
                <MudText Typo="Typo.subtitle2" Class="mb-2">Type</MudText>
                <div class="d-flex gap-2 flex-wrap">
                    <MudButton Variant="@(IsStdio ? Variant.Filled : Variant.Outlined)" Color="Color.Primary" OnClick="@(() => SetType(StdioType))">STDIO</MudButton>
                    <MudButton Variant="@(IsStdio ? Variant.Outlined : Variant.Filled)" Color="Color.Primary" OnClick="@(() => SetType(HttpType))">SSE or Streamable HTTP</MudButton>
                </div>
            </div>

            <div @key="_type">
            @if (IsStdio)
            {
                <MudTextField @bind-Value="_command" Label="Command" Variant="Variant.Outlined" Placeholder="Enter command to run" Required="true" RequiredError="Please enter command" />
                <MudTextField @bind-Value="_argsString" Label="Args" Variant="Variant.Outlined" Placeholder="Enter args (space-separated)" />

                <div>
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Environment variables (env)</MudText>
                    <MudTable Items="@_envRows" Dense="true" Breakpoint="Breakpoint.Sm" Hover="true">
                        <HeaderContent>
                            <MudTh>Env key</MudTh>
                            <MudTh>Env value</MudTh>
                            <MudTh Style="width: 80px;">Action</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Env key"><MudTextField @bind-Value="context.Key" Placeholder="Enter env key" Variant="Variant.Outlined" Margin="Margin.Dense" /></MudTd>
                            <MudTd DataLabel="Env value"><MudTextField @bind-Value="context.Value" Placeholder="Enter env value" Variant="Variant.Outlined" Margin="Margin.Dense" /></MudTd>
                            <MudTd DataLabel="Action">
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" OnClick="@(() => RemoveEnvRow(context))" title="Delete" />
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                    <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Add" OnClick="@AddEnvRow" Class="mt-1">Add env var</MudButton>
                </div>
            }
            else
            {
                <MudTextField @bind-Value="_url" Label="Service URL" Variant="Variant.Outlined" Placeholder="Enter SSE endpoint or Streamable HTTP URL" Required="true" RequiredError="Please enter service URL" />

                <MudExpansionPanels Class="mt-2">
                    <MudExpansionPanel Text="Advanced" expanded="false">
                        <div>
                            <MudText Typo="Typo.body2" Class="mb-2">Request headers (headers)</MudText>
                            <MudTable Items="@_headerRows" Dense="true" Breakpoint="Breakpoint.Sm" Hover="true">
                                <HeaderContent>
                                    <MudTh>Header key</MudTh>
                                    <MudTh>Header value</MudTh>
                                    <MudTh Style="width: 80px;">Action</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Header key"><MudTextField @bind-Value="context.Key" Placeholder="Enter header key" Variant="Variant.Outlined" Margin="Margin.Dense" /></MudTd>
                                    <MudTd DataLabel="Header value"><MudTextField @bind-Value="context.Value" Placeholder="Enter header value" Variant="Variant.Outlined" Margin="Margin.Dense" /></MudTd>
                                    <MudTd DataLabel="Action">
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" OnClick="@(() => RemoveHeaderRow(context))" title="Delete" />
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>
                            <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Add" OnClick="@AddHeaderRow" Class="mt-1">Add header</MudButton>
                        </div>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            }
            </div>
        </div>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="@Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@Submit">@(IsEdit ? "Save" : "Add")</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private const string StdioType = "stdio";
    private const string HttpType = "http";

    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public string? EditId { get; set; }
    [Parameter] public McpServerEntry? EditEntry { get; set; }

    private bool IsEdit => !string.IsNullOrEmpty(EditId);
    private bool IsStdio => StdioType.Equals(_type, StringComparison.OrdinalIgnoreCase);

    private string _name = "";
    private string _type = StdioType;
    private string _command = "";
    private string _argsString = "";
    private string _url = "";
    private readonly List<KeyValueRow> _envRows = [];
    private readonly List<KeyValueRow> _headerRows = [];

    protected override void OnInitialized()
    {
        if (IsEdit && EditEntry != null)
        {
            _name = EditId ?? "";
            _type = "http".Equals(EditEntry.Type, StringComparison.OrdinalIgnoreCase) ? HttpType : StdioType;
            _command = EditEntry.Command ?? "";
            _argsString = EditEntry.Args != null ? string.Join(" ", EditEntry.Args) : "";
            _url = EditEntry.Url ?? "";
            _envRows.Clear();
            if (EditEntry.Env != null)
            {
                foreach (var kv in EditEntry.Env)
                    _envRows.Add(new KeyValueRow { Key = kv.Key, Value = kv.Value ?? "" });
            }
            _headerRows.Clear();
            if (EditEntry.Headers != null)
            {
                foreach (var kv in EditEntry.Headers)
                    _headerRows.Add(new KeyValueRow { Key = kv.Key, Value = kv.Value ?? "" });
            }
        }
        if (_envRows.Count == 0) _envRows.Add(new KeyValueRow());
        if (_headerRows.Count == 0) _headerRows.Add(new KeyValueRow());
    }

    private void SetType(string value)
    {
        _type = value;
        StateHasChanged();
    }

    private void AddEnvRow() => _envRows.Add(new KeyValueRow());
    private void RemoveEnvRow(KeyValueRow row) => _envRows.Remove(row);
    private void AddHeaderRow() => _headerRows.Add(new KeyValueRow());
    private void RemoveHeaderRow(KeyValueRow row) => _headerRows.Remove(row);

    private void Cancel() => MudDialog.Cancel();

    private async Task Submit()
    {
        var id = _name.Trim();
        if (string.IsNullOrEmpty(id))
        {
            Snackbar.Add("Please enter service name", Severity.Warning);
            return;
        }
        if (IsStdio)
        {
            var cmd = _command.Trim();
            if (string.IsNullOrEmpty(cmd))
            {
                Snackbar.Add("Please enter command", Severity.Warning);
                return;
            }
        }
        else
        {
            var u = _url.Trim();
            if (string.IsNullOrEmpty(u))
            {
                Snackbar.Add("Please enter service URL", Severity.Warning);
                return;
            }
        }

        var entry = new McpServerEntry();
        if (IsStdio)
        {
            entry.Type = StdioType;
            entry.Command = _command.Trim();
            entry.Args = string.IsNullOrWhiteSpace(_argsString)
                ? []
                : _argsString.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            entry.Env = _envRows
                .Where(r => !string.IsNullOrWhiteSpace(r.Key))
                .ToDictionary(r => r.Key.Trim(), r => r.Value?.Trim());
        }
        else
        {
            entry.Type = HttpType;
            entry.Url = _url.Trim();
            var headers = _headerRows
                .Where(r => !string.IsNullOrWhiteSpace(r.Key))
                .ToDictionary(r => r.Key.Trim(), r => r.Value?.Trim());
            if (headers.Count > 0) entry.Headers = headers;
        }

        MudDialog.Close(DialogResult.Ok((Id: id, Entry: entry)));
        await Task.CompletedTask;
    }

    private sealed class KeyValueRow
    {
        public string Key { get; set; } = "";
        public string? Value { get; set; } = "";
    }
}
