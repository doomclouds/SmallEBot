@inject IMcpConfigService McpConfig
@inject IMcpToolsLoaderService McpToolsLoader
@inject AgentService AgentService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">MCP 配置</MudText>
    </TitleContent>
    <DialogContent>
        @if (_loading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        }
        else
        {
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="StartAdd" Class="mb-3">新增 MCP</MudButton>
            <MudTable Items="@_rows" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true">
                <HeaderContent>
                    <MudTh Style="width: 48px;"></MudTh>
                    <MudTh>名称</MudTh>
                    <MudTh>类型</MudTh>
                    <MudTh>信息</MudTh>
                    <MudTh>来源</MudTh>
                    <MudTh>启用</MudTh>
                    <MudTh Style="width: 120px;">操作</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>
                        <MudIconButton Icon="@(_expandedId == context.Id ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" Size="Size.Small" OnClick="@(() => ToggleExpand(context))" title="@(_expandedId == context.Id ? "收起" : "展开")" />
                    </MudTd>
                    <MudTd DataLabel="名称">@context.Id</MudTd>
                    <MudTd DataLabel="类型">@GetTypeLabel(context.Entry)</MudTd>
                    <MudTd DataLabel="信息">@GetInfoLabel(context.Entry)</MudTd>
                    <MudTd DataLabel="来源">@(context.IsSystem ? "系统" : "用户")</MudTd>
                    <MudTd DataLabel="启用">
                        <MudSwitch T="bool" value="@context.IsEnabled" ValueChanged="@GetToggleCallback(context.Id)" Color="Color.Primary" />
                    </MudTd>
                    <MudTd DataLabel="操作">
                        @if (!context.IsSystem)
                        {
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" OnClick="@(async () => await StartEdit(context.Id))" title="编辑" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" OnClick="@(async () => await ConfirmAndDeleteMcp(context.Id))" title="删除" />
                        }
                    </MudTd>
                </RowTemplate>
                <ChildRowContent>
                    @if (_expandedId == context.Id)
                    {
                        <MudTr>
                            <td colspan="7" class="pa-4">
                                @if (_loadingToolsIds.Contains(context.Id))
                                {
                                    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-2" />
                                    <MudText Typo="Typo.body2">加载中…</MudText>
                                }
                                else if (_toolsCache.TryGetValue(context.Id, out var result))
                                {
                                    @if (result.Error != null)
                                    {
                                        <MudText Typo="Typo.body2" Color="Color.Error">加载失败: @result.Error</MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.subtitle2" Class="mb-2">工具</MudText>
                                        @if (result.Tools.Count == 0)
                                        {
                                            <MudText Typo="Typo.body2" Class="mb-3">无</MudText>
                                        }
                                        else
                                        {
                                            <ul class="mb-3 pl-4">
                                                @foreach (var t in result.Tools)
                                                {
                                                    <li><strong>@t.Name</strong> @(string.IsNullOrEmpty(t.Description) ? "" : "— " + t.Description)</li>
                                                }
                                            </ul>
                                        }
                                        <MudText Typo="Typo.subtitle2" Class="mb-2">提示词</MudText>
                                        @if (result.Prompts == null || result.Prompts.Count == 0)
                                        {
                                            <MudText Typo="Typo.body2">—</MudText>
                                        }
                                        else
                                        {
                                            <ul class="pl-4">
                                                @foreach (var p in result.Prompts)
                                                {
                                                    <li><strong>@p.Name</strong> @(string.IsNullOrEmpty(p.Description) ? "" : "— " + p.Description)</li>
                                                }
                                            </ul>
                                        }
                                    }
                                }
                            </td>
                        </MudTr>
                    }
                </ChildRowContent>
            </MudTable>
        }
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="Close">关闭</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;

    private bool _loading = true;
    private List<McpRowViewModel> _rows = [];
    private HashSet<string> _systemIds = [];
    private string? _expandedId;
    private readonly Dictionary<string, McpToolsLoadResult> _toolsCache = [];
    private readonly HashSet<string> _loadingToolsIds = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadListAsync();
    }

    private async Task LoadListAsync()
    {
        _loading = true;
        try
        {
            var all = await McpConfig.GetAllAsync();
            _systemIds = all.Where(x => x.IsSystem).Select(x => x.Id).ToHashSet();
            _rows = all.Select(x => new McpRowViewModel(x.Id, x.Entry, x.IsSystem, x.IsEnabled)).ToList();
        }
        catch
        {
            Snackbar.Add("加载 MCP 配置失败", Severity.Warning);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task StartAdd()
    {
        var dialog = await DialogService.ShowAsync<SmallEBot.Components.Mcp.AddMcpServiceDialog>("添加 MCP 服务", new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });
        var result = await dialog.Result;
        if (result?.Canceled != false) return;
        if (result.Data is not (string id, SmallEBot.Models.McpServerEntry entry))
            return;
        await SaveFromAddDialog(id, entry, isEdit: false);
    }

    private async Task StartEdit(string id)
    {
        var row = _rows.FirstOrDefault(r => r.Id == id);
        if (row == null) return;
        var parameters = new DialogParameters
        {
            [nameof(AddMcpServiceDialog.EditId)] = id,
            [nameof(AddMcpServiceDialog.EditEntry)] = row.Entry
        };
        var dialog = await DialogService.ShowAsync<SmallEBot.Components.Mcp.AddMcpServiceDialog>("编辑 MCP 服务", parameters, new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });
        var result = await dialog.Result;
        if (result?.Canceled != false) return;
        if (result.Data is not (string newId, SmallEBot.Models.McpServerEntry entry))
            return;
        await SaveFromAddDialog(newId, entry, isEdit: true, oldId: id);
    }

    private async Task SaveFromAddDialog(string id, SmallEBot.Models.McpServerEntry entry, bool isEdit, string? oldId = null)
    {
        var trimmedId = id.Trim();
        if (string.IsNullOrEmpty(trimmedId))
        {
            Snackbar.Add("请输入名称", Severity.Warning);
            return;
        }
        if (_systemIds.Contains(trimmedId) && (isEdit ? trimmedId != oldId : true))
        {
            Snackbar.Add("该名称已被系统 MCP 使用，请使用其他名称", Severity.Warning);
            return;
        }
        var user = await McpConfig.GetUserMcpAsync();
        var dict = new Dictionary<string, SmallEBot.Models.McpServerEntry>(user);
        if (isEdit && !string.IsNullOrEmpty(oldId)) dict.Remove(oldId);
        dict[trimmedId] = entry;
        try
        {
            await McpConfig.SaveUserMcpAsync(dict);
            await AgentService.InvalidateAgentAsync();
            Snackbar.Add(isEdit ? "已保存" : "已添加", Severity.Success);
            await LoadListAsync();
        }
        catch
        {
            Snackbar.Add("保存失败", Severity.Error);
        }
    }

    private async Task ToggleExpand(McpRowViewModel row)
    {
        if (_expandedId == row.Id)
        {
            _expandedId = null;
            return;
        }
        _expandedId = row.Id;
        if (!_toolsCache.ContainsKey(row.Id) && !_loadingToolsIds.Contains(row.Id))
        {
            _loadingToolsIds.Add(row.Id);
            StateHasChanged();
            try
            {
                var result = await McpToolsLoader.LoadAsync(row.Id, row.Entry);
                _toolsCache[row.Id] = result;
            }
            finally
            {
                _loadingToolsIds.Remove(row.Id);
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private async Task ConfirmAndDeleteMcp(string id)
    {
        var parameters = new DialogParameters { [nameof(DeleteMcpConfirmDialog.Name)] = id };
        var dialog = await DialogService.ShowAsync<DeleteMcpConfirmDialog>("删除 MCP", parameters);
        var result = await dialog.Result;
        if (result?.Canceled == true) return;
        if (result?.Data is true)
            await DeleteUserMcp(id);
    }

    private async Task DeleteUserMcp(string id)
    {
        var user = await McpConfig.GetUserMcpAsync();
        var dict = new Dictionary<string, SmallEBot.Models.McpServerEntry>(user);
        dict.Remove(id);
        try
        {
            await McpConfig.SaveUserMcpAsync(dict);
            await AgentService.InvalidateAgentAsync();
            Snackbar.Add("已删除", Severity.Success);
            await LoadListAsync();
        }
        catch (Exception)
        {
            Snackbar.Add("删除失败", Severity.Error);
        }
    }

    private static string GetTypeLabel(SmallEBot.Models.McpServerEntry entry)
    {
        if ("http".Equals(entry.Type, StringComparison.OrdinalIgnoreCase)) return "HTTP";
        if ("stdio".Equals(entry.Type, StringComparison.OrdinalIgnoreCase) || !string.IsNullOrEmpty(entry.Command)) return "Stdio";
        return entry.Type ?? "—";
    }

    private static string GetInfoLabel(SmallEBot.Models.McpServerEntry entry)
    {
        if (!string.IsNullOrEmpty(entry.Url)) return entry.Url;
        if (!string.IsNullOrEmpty(entry.Command)) return entry.Command;
        return "—";
    }

    private EventCallback<bool> GetToggleCallback(string id) =>
        EventCallback.Factory.Create<bool>(this, async v => await OnToggleEnabled(id, v));

    private async Task OnToggleEnabled(string id, bool enabled)
    {
        var row = _rows.FirstOrDefault(r => r.Id == id);
        if (row != null) row.IsEnabled = enabled;
        try
        {
            if (row?.IsSystem == true)
            {
                var disabled = await McpConfig.GetDisabledSystemIdsAsync();
                var list = disabled.ToList();
                if (enabled)
                    list.Remove(id);
                else if (!list.Contains(id))
                    list.Add(id);
                await McpConfig.SetDisabledSystemIdsAsync(list);
            }
            else
            {
                var user = await McpConfig.GetUserMcpAsync();
                var dict = new Dictionary<string, SmallEBot.Models.McpServerEntry>(user);
                if (dict.TryGetValue(id, out var entry))
                {
                    entry.Enabled = enabled;
                    await McpConfig.SaveUserMcpAsync(dict);
                }
            }
            await AgentService.InvalidateAgentAsync();
        }
        catch
        {
            Snackbar.Add("保存启用状态失败", Severity.Warning);
        }
    }

    private void Close() => MudDialog.Close();

    private sealed class McpRowViewModel
    {
        public string Id { get; }
        public SmallEBot.Models.McpServerEntry Entry { get; }
        public bool IsSystem { get; }
        public bool IsEnabled { get; set; }
        public McpRowViewModel(string id, SmallEBot.Models.McpServerEntry entry, bool isSystem, bool isEnabled)
        {
            Id = id;
            Entry = entry;
            IsSystem = isSystem;
            IsEnabled = isEnabled;
        }
    }
}
