@using SmallEBot.Models
@inject IMcpConfigService McpConfig
@inject IMcpToolsLoaderService McpToolsLoader
@inject AgentCacheService AgentCache
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">MCP config</MudText>
    </TitleContent>
    <DialogContent>
        @if (_loading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        }
        else
        {
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="@StartAdd" Class="mb-3">Add MCP</MudButton>
            <MudTable Items="@_rows" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true">
                <HeaderContent>
                    <MudTh Style="width: 48px;"></MudTh>
                    <MudTh>Name</MudTh>
                    <MudTh>Type</MudTh>
                    <MudTh>Info</MudTh>
                    <MudTh>Source</MudTh>
                    <MudTh>Enabled</MudTh>
                    <MudTh Style="width: 120px;">Action</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>
                        <MudIconButton Icon="@(_expandedId == context.Id ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" Size="Size.Small" OnClick="@(() => ToggleExpand(context))" title="@(_expandedId == context.Id ? "Collapse" : "Expand")" />
                    </MudTd>
                    <MudTd DataLabel="Name">@context.Id</MudTd>
                    <MudTd DataLabel="Type">@GetTypeLabel(context.Entry)</MudTd>
                    <MudTd DataLabel="Info">@GetInfoLabel(context.Entry)</MudTd>
                    <MudTd DataLabel="Source">@(context.IsSystem ? "System" : "User")</MudTd>
                    <MudTd DataLabel="Enabled">
                        <MudSwitch T="bool" value="@context.IsEnabled" ValueChanged="@GetToggleCallback(context.Id)" Color="Color.Primary" />
                    </MudTd>
                    <MudTd DataLabel="Action">
                        @if (!context.IsSystem)
                        {
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" OnClick="@(async () => await StartEdit(context.Id))" title="Edit" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" OnClick="@(async () => await ConfirmAndDeleteMcp(context.Id))" title="Delete" />
                        }
                    </MudTd>
                </RowTemplate>
                <ChildRowContent>
                    @if (_expandedId == context.Id)
                    {
                        <MudTr>
                            <td colspan="7" class="pa-4">
                                @if (_loadingToolsIds.Contains(context.Id))
                                {
                                    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-2" />
                                    <MudText Typo="Typo.body2">Loading…</MudText>
                                }
                                else if (_toolsCache.TryGetValue(context.Id, out var result))
                                {
                                    @if (result.Error != null)
                                    {
                                        <MudText Typo="Typo.body2" Color="Color.Error">Load failed: @result.Error</MudText>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.subtitle2" Class="mb-2">Tools</MudText>
                                        @if (result.Tools.Count == 0)
                                        {
                                            <MudText Typo="Typo.body2" Class="mb-3">None</MudText>
                                        }
                                        else
                                        {
                                            <ul class="mb-3 pl-4">
                                                @foreach (var t in result.Tools)
                                                {
                                                    <li><strong>@t.Name</strong> @(string.IsNullOrEmpty(t.Description) ? "" : "— " + t.Description)</li>
                                                }
                                            </ul>
                                        }
                                        <MudText Typo="Typo.subtitle2" Class="mb-2">Prompts</MudText>
                                        @if (result.Prompts == null || result.Prompts.Count == 0)
                                        {
                                            <MudText Typo="Typo.body2">—</MudText>
                                        }
                                        else
                                        {
                                            <ul class="pl-4">
                                                @foreach (var p in result.Prompts)
                                                {
                                                    <li><strong>@p.Name</strong> @(string.IsNullOrEmpty(p.Description) ? "" : "— " + p.Description)</li>
                                                }
                                            </ul>
                                        }
                                    }
                                }
                            </td>
                        </MudTr>
                    }
                </ChildRowContent>
            </MudTable>
        }
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="@Close">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;

    private bool _loading = true;
    private List<McpRowViewModel> _rows = [];
    private HashSet<string> _systemIds = [];
    private string? _expandedId;
    private readonly Dictionary<string, McpToolsLoadResult> _toolsCache = [];
    private readonly HashSet<string> _loadingToolsIds = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadListAsync();
    }

    private async Task LoadListAsync()
    {
        _loading = true;
        try
        {
            var all = await McpConfig.GetAllAsync();
            _systemIds = all.Where(x => x.IsSystem).Select(x => x.Id).ToHashSet();
            _rows = all.Select(x => new McpRowViewModel(x.Id, x.Entry, x.IsSystem, x.IsEnabled)).ToList();
        }
        catch
        {
            Snackbar.Add("Failed to load MCP config", Severity.Warning);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task StartAdd()
    {
        var dialog = await DialogService.ShowAsync<AddMcpServiceDialog>("Add MCP service", new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });
        var result = await dialog.Result;
        if (result?.Canceled != false) return;
        if (result.Data is not (string id, McpServerEntry entry))
            return;
        await SaveFromAddDialog(id, entry, isEdit: false);
    }

    private async Task StartEdit(string id)
    {
        var row = _rows.FirstOrDefault(r => r.Id == id);
        if (row == null) return;
        var parameters = new DialogParameters
        {
            [nameof(AddMcpServiceDialog.EditId)] = id,
            [nameof(AddMcpServiceDialog.EditEntry)] = row.Entry
        };
        var dialog = await DialogService.ShowAsync<AddMcpServiceDialog>("Edit MCP service", parameters, new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });
        var result = await dialog.Result;
        if (result?.Canceled != false) return;
        if (result.Data is not (string newId, McpServerEntry entry))
            return;
        await SaveFromAddDialog(newId, entry, isEdit: true, oldId: id);
    }

    private async Task SaveFromAddDialog(string id, McpServerEntry entry, bool isEdit, string? oldId = null)
    {
        var trimmedId = id.Trim();
        if (string.IsNullOrEmpty(trimmedId))
        {
            Snackbar.Add("Please enter a name", Severity.Warning);
            return;
        }
        if (_systemIds.Contains(trimmedId) && (!isEdit || trimmedId != oldId))
        {
            Snackbar.Add("This name is already used by a system MCP. Please use another name.", Severity.Warning);
            return;
        }
        var user = await McpConfig.GetUserMcpAsync();
        var dict = new Dictionary<string, McpServerEntry>(user);
        if (isEdit && !string.IsNullOrEmpty(oldId)) dict.Remove(oldId);
        dict[trimmedId] = entry;
        try
        {
            await McpConfig.SaveUserMcpAsync(dict);
            await AgentCache.InvalidateAgentAsync();
            Snackbar.Add(isEdit ? "Saved" : "Added", Severity.Success);
            await LoadListAsync();
        }
        catch
        {
            Snackbar.Add("Save failed", Severity.Error);
        }
    }

    private async Task ToggleExpand(McpRowViewModel row)
    {
        if (_expandedId == row.Id)
        {
            _expandedId = null;
            return;
        }
        _expandedId = row.Id;
        if (!_toolsCache.ContainsKey(row.Id) && !_loadingToolsIds.Contains(row.Id))
        {
            _loadingToolsIds.Add(row.Id);
            StateHasChanged();
            try
            {
                var result = await McpToolsLoader.LoadAsync(row.Id, row.Entry);
                _toolsCache[row.Id] = result;
            }
            finally
            {
                _loadingToolsIds.Remove(row.Id);
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private async Task ConfirmAndDeleteMcp(string id)
    {
        var parameters = new DialogParameters { [nameof(DeleteMcpConfirmDialog.Name)] = id };
        var dialog = await DialogService.ShowAsync<DeleteMcpConfirmDialog>("Delete MCP", parameters);
        var result = await dialog.Result;
        if (result?.Canceled == true) return;
        if (result?.Data is true)
            await DeleteUserMcp(id);
    }

    private async Task DeleteUserMcp(string id)
    {
        var user = await McpConfig.GetUserMcpAsync();
        var dict = new Dictionary<string, McpServerEntry>(user);
        dict.Remove(id);
        try
        {
            await McpConfig.SaveUserMcpAsync(dict);
            await AgentCache.InvalidateAgentAsync();
            Snackbar.Add("Deleted", Severity.Success);
            await LoadListAsync();
        }
        catch (Exception)
        {
            Snackbar.Add("Delete failed", Severity.Error);
        }
    }

    private static string GetTypeLabel(McpServerEntry entry)
    {
        if ("http".Equals(entry.Type, StringComparison.OrdinalIgnoreCase)) return "HTTP";
        if ("stdio".Equals(entry.Type, StringComparison.OrdinalIgnoreCase) || !string.IsNullOrEmpty(entry.Command)) return "Stdio";
        return entry.Type ?? "—";
    }

    private static string GetInfoLabel(McpServerEntry entry)
    {
        if (!string.IsNullOrEmpty(entry.Url)) return entry.Url;
        if (!string.IsNullOrEmpty(entry.Command)) return entry.Command;
        return "—";
    }

    private EventCallback<bool> GetToggleCallback(string id) =>
        EventCallback.Factory.Create<bool>(this, async v => await OnToggleEnabled(id, v));

    private async Task OnToggleEnabled(string id, bool enabled)
    {
        var row = _rows.FirstOrDefault(r => r.Id == id);
        row?.IsEnabled = enabled;
        try
        {
            if (row?.IsSystem == true)
            {
                var disabled = await McpConfig.GetDisabledSystemIdsAsync();
                var list = disabled.ToList();
                if (enabled)
                    list.Remove(id);
                else if (!list.Contains(id))
                    list.Add(id);
                await McpConfig.SetDisabledSystemIdsAsync(list);
            }
            else
            {
                var user = await McpConfig.GetUserMcpAsync();
                var dict = new Dictionary<string, McpServerEntry>(user);
                if (dict.TryGetValue(id, out var entry))
                {
                    entry.Enabled = enabled;
                    await McpConfig.SaveUserMcpAsync(dict);
                }
            }
            await AgentCache.InvalidateAgentAsync();
        }
        catch
        {
            Snackbar.Add("Failed to save enable state", Severity.Warning);
        }
    }

    private void Close() => MudDialog.Close();

    private sealed class McpRowViewModel(string id, McpServerEntry entry, bool isSystem, bool isEnabled)
    {
        public string Id { get; } = id;
        public McpServerEntry Entry { get; } = entry;
        public bool IsSystem { get; } = isSystem;
        public bool IsEnabled { get; set; } = isEnabled;
    }
}
