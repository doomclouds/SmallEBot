@inject ISkillsConfigService SkillsConfig
@inject ISnackbar Snackbar
@inject IJSRuntime JS

<MudDialog>
    <TitleContent><MudText Typo="Typo.h6">Import Skill</MudText></TitleContent>
    <DialogContent>
        <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.FolderOpen" OnClick="@PickFolder" Class="mb-2">Select folder</MudButton>
        @if (!string.IsNullOrEmpty(_pickedFolderName))
        {
            <MudText Typo="Typo.body2" Class="mb-2">Selected: @_pickedFolderName</MudText>
        }
        <MudTextField @bind-Value="_id" Label="Skill Id (optional, defaults to folder name)" Variant="Variant.Outlined" Class="mb-2" />
        <MudText Typo="Typo.caption">The selected folder must contain SKILL.md with valid frontmatter.</MudText>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="@Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@Import" Disabled="@(_pickedFiles == null)">Import</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;
    private string _id = "";
    private string _pickedFolderName = "";
    private IReadOnlyDictionary<string, string>? _pickedFiles;

    private void Cancel() => MudDialog.Cancel();

    private async Task PickFolder()
    {
        try
        {
            var result = await JS.InvokeAsync<System.Text.Json.JsonElement>("SmallEBotPickSkillFolder");
            if (result.ValueKind is System.Text.Json.JsonValueKind.Null or System.Text.Json.JsonValueKind.Undefined)
                return;
            _pickedFolderName = result.GetProperty("folderName").GetString() ?? "";
            var filesEl = result.GetProperty("files");
            var dict = new Dictionary<string, string>();
            foreach (var prop in filesEl.EnumerateObject())
                dict[prop.Name] = prop.Value.GetString() ?? "";
            _pickedFiles = dict;
            if (string.IsNullOrWhiteSpace(_id))
                _id = _pickedFolderName;
        }
        catch (Exception ex)
        {
            Snackbar.Add("Failed to pick folder: " + ex.Message, Severity.Error);
        }
    }

    private async Task Import()
    {
        if (_pickedFiles == null || _pickedFiles.Count == 0)
        {
            Snackbar.Add("Please select a folder first.", Severity.Warning);
            return;
        }
        try
        {
            await SkillsConfig.ImportUserSkillFromFileContentsAsync(
                string.IsNullOrWhiteSpace(_id) ? null : _id.Trim(),
                _pickedFiles);
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add("Import failed: " + ex.Message, Severity.Error);
        }
    }
}
