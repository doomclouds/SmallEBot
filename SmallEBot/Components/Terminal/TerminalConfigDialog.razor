@using SmallEBot.Services.Terminal
@inject ITerminalConfigService TerminalConfig
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">Terminal config</MudText>
    </TitleContent>
    <DialogContent>
        <MudText Typo="Typo.subtitle2" Class="mb-2">Command blacklist</MudText>
        <MudText Typo="Typo.body2" Class="mb-3">Commands that contain any of these entries (case-insensitive) will be blocked when the agent runs shell commands.</MudText>
        @if (_loading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
        }
        else
        {
            <MudStack Row="true" Class="mb-3" AlignItems="AlignItems.Center">
                <MudTextField @bind-Value="_newEntry"
                             Label="New entry"
                             Variant="Variant.Outlined"
                             Margin="Margin.Dense"
                             Style="max-width: 320px;"
                             Placeholder="e.g. dangerous_cmd"
                             OnKeyDown="@OnNewEntryKeyDown" />
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="AddEntry"
                           Disabled="@string.IsNullOrWhiteSpace(_newEntry)">
                    Add
                </MudButton>
            </MudStack>
            @if (_entries.Count == 0)
            {
                <MudText Typo="Typo.body2" Class="mb-3">No entries. Add one above or save to persist the default list.</MudText>
            }
            else
            {
                <MudList T="string" Dense="true" Class="mb-3" Style="max-height: 320px; overflow-y: auto;">
                    @foreach (var entry in _entries)
                    {
                        var item = entry;
                        <MudListItem T="string">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                <MudText Typo="Typo.body2" Style="word-break: break-all;">@item</MudText>
                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                               Size="Size.Small"
                                               OnClick="@(() => RemoveEntry(item))"
                                               title="Remove" />
                            </MudStack>
                        </MudListItem>
                    }
                </MudList>
            }
        }
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Save">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    public IMudDialogInstance MudDialog { get; set; } = null!;

    private bool _loading = true;
    private List<string> _entries = [];
    private string _newEntry = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var list = await TerminalConfig.GetCommandBlacklistAsync();
            _entries = list.ToList();
        }
        catch
        {
            Snackbar.Add("Failed to load terminal config", Severity.Warning);
        }
        finally
        {
            _loading = false;
        }
    }

    private void AddEntry()
    {
        var trimmed = _newEntry?.Trim() ?? "";
        if (string.IsNullOrEmpty(trimmed))
            return;
        if (_entries.Contains(trimmed, StringComparer.OrdinalIgnoreCase))
        {
            Snackbar.Add("Entry already in list", Severity.Warning);
            return;
        }
        _entries.Add(trimmed);
        _newEntry = "";
    }

    private void OnNewEntryKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            AddEntry();
    }

    private void RemoveEntry(string entry)
    {
        _entries.Remove(entry);
    }

    private async Task Save()
    {
        try
        {
            await TerminalConfig.SaveCommandBlacklistAsync(_entries);
            Snackbar.Add("Saved", Severity.Success);
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch
        {
            Snackbar.Add("Save failed", Severity.Error);
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
