@using SmallEBot.Data.Entities
@inject ConversationService ConvSvc
@inject UserNameService UserNameSvc
@inject IDialogService DialogSvc
@inject ISnackbar Snackbar

<MudDrawer Open="@_open" Variant="DrawerVariant.Persistent" Anchor="Anchor.Left" Class="smallebot-drawer">
    <MudDrawerHeader>
        <MudText Typo="Typo.h6">Conversations</MudText>
    </MudDrawerHeader>
    <MudNavMenu>
        <MudMenuItem Icon="@Icons.Material.Filled.Add" OnClick="@CreateNew">New</MudMenuItem>
        <MudList T="Conversation" Dense="true"
                 SelectedValue="@SelectedConversation"
                 SelectedValueChanged="@HandleSelectionChanged">
            @foreach (var conversation in Conversations)
            {
                <MudListItem T="Conversation" Value="@conversation">
                    <div class="d-flex justify-space-between align-center" style="width:100%">
                        <div>
                            <MudText Typo="Typo.body1">@(string.IsNullOrEmpty(conversation.Title) ? "新对话" : conversation.Title)</MudText>
                            <MudText Typo="Typo.caption">@conversation.UpdatedAt.ToString("g")</MudText>
                        </div>
                        <div @onclick="() => { }" @onclick:stopPropagation="true">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Size="Size.Small"
                                           OnClick="@(() => DeleteConversation(conversation.Id))" />
                        </div>
                    </div>
                </MudListItem>
            }
        </MudList>
    </MudNavMenu>
</MudDrawer>

@code {
    [Parameter] public List<Conversation> Conversations { get; set; } = [];
    [Parameter] public Guid? SelectedId { get; set; }
    [Parameter] public EventCallback<Guid> OnSelect { get; set; }
    [Parameter] public EventCallback<Guid> OnDelete { get; set; }
    [Parameter] public EventCallback OnCreate { get; set; }
    [Parameter] public string UserName { get; set; } = "";
    [Parameter] public bool Open { get; set; } = true;

    private bool _open = true;
    private Conversation? SelectedConversation => Conversations.FirstOrDefault(c => c.Id == SelectedId);

    private async Task HandleSelectionChanged(Conversation? c)
    {
        if (c != null) await OnSelect.InvokeAsync(c.Id);
    }

    protected override void OnParametersSet()
    {
        _open = Open;
    }

    private async Task CreateNew() => await OnCreate.InvokeAsync();

    private async Task DeleteConversation(Guid id)
    {
        var dialog = await DialogSvc.ShowAsync<DeleteConversationDialog>("Delete conversation");
        var result = await dialog.Result;
        if (result == null || result.Canceled || result.Data is not true)
            return;

        var userName = await UserNameSvc.GetAsync() ?? UserName;
        if (string.IsNullOrWhiteSpace(userName))
        {
            Snackbar.Add("Username missing, cannot delete.", Severity.Warning);
            return;
        }
        var ok = await ConvSvc.DeleteAsync(id, userName);
        if (ok)
            await OnDelete.InvokeAsync(id);
        else
            Snackbar.Add("Delete failed (conversation not found or access denied).", Severity.Error);
    }
}
