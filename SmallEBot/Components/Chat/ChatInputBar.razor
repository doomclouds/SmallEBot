@* Chat input bar: multiline text area, bottom bar with compress button, context % and send/stop icon. Enter=send, Shift+Enter=newline. *@
@inject IJSRuntime JS
@implements IDisposable

<div id="smallebot-chat-input-wrap" class="d-flex flex-column gap-1 @Class">
    <MudTextField Value="@Value"
                  ValueChanged="@(EventCallback.Factory.Create<string>(this, OnValueChanged))"
                  Lines="2"
                  Placeholder="@("Plan, @ for context, / for commands")"
                  Variant="Variant.Outlined"
                  FullWidth="true"
                  Immediate="true"
                  Class="smallebot-chat-input"
                  Disabled="@Compressing"
                  OnKeyDown="@HandleKeyDown" />
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mt-1">
        <MudIconButton Icon="@Icons.Material.Filled.Compress"
                       Color="Color.Default"
                       OnClick="@OnCompress"
                       Disabled="@(Compressing || Streaming)"
                       Size="Size.Small"
                       title="Compress context"
                       aria-label="Compress context" />
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            @if (!string.IsNullOrEmpty(ContextUsageTooltip))
{
    <MudTooltip Text="@ContextUsageTooltip">
        <MudText Typo="Typo.body2" Class="text-secondary" Style="min-width: 2.5rem;">@ContextPercentText</MudText>
    </MudTooltip>
}
else
{
    <MudText Typo="Typo.body2" Class="text-secondary" Style="min-width: 2.5rem;">@ContextPercentText</MudText>
}
            @if (Streaming)
            {
                <MudIconButton Icon="@Icons.Material.Filled.Stop"
                               Color="Color.Secondary"
                               OnClick="@OnStop"
                               Disabled="@Compressing"
                               title="Stop"
                               aria-label="Stop" />
            }
            else
            {
                <MudIconButton Icon="@Icons.Material.Filled.ArrowUpward"
                               Color="Color.Primary"
                               OnClick="@OnSend"
                               Disabled="@(Disabled || Compressing)"
                               title="Send"
                               aria-label="Send" />
            }
        </MudStack>
    </MudStack>
</div>

@code {
    [Parameter] public string Value { get; set; } = "";
    [Parameter] public EventCallback<string> ValueChanged { get; set; }
    [Parameter] public bool Streaming { get; set; }
    [Parameter] public bool Compressing { get; set; }
    [Parameter] public string ContextPercentText { get; set; } = "0%";
    [Parameter] public string? ContextUsageTooltip { get; set; }
    [Parameter] public EventCallback OnSend { get; set; }
    [Parameter] public EventCallback OnStop { get; set; }
    [Parameter] public EventCallback OnCompress { get; set; }
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public string Class { get; set; } = "";
    [Parameter] public EventCallback<KeyboardEventArgs> OnKeyDown { get; set; }

    private DotNetObjectReference<ChatInputBar>? _dotNetRef;
    private bool _attachDone;

    private async Task OnValueChanged(string v)
    {
        Value = v;
        await ValueChanged.InvokeAsync(v);
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        await OnKeyDown.InvokeAsync(e);
    }

    [JSInvokable]
    public Task InvokeSend() => OnSend.InvokeAsync();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_attachDone)
        {
            _attachDone = true;
            _dotNetRef = DotNetObjectReference.Create(this);
            try
            {
                await JS.InvokeVoidAsync("SmallEBot.attachChatInputSend", "smallebot-chat-input-wrap", _dotNetRef);
            }
            catch { /* JS not loaded yet */ }
        }
    }

    public void Dispose() => _dotNetRef?.Dispose();
}
