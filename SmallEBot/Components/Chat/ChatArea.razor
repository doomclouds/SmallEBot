@using SmallEBot.Data.Entities
@using SmallEBot.Models
@inject AgentService AgentSvc
@inject UserNameService UserNameSvc
@inject IJSRuntime JS
@inject ISnackbar Snackbar

<MudPaper Class="pa-4" Elevation="2">
    <div @ref="_chatScrollRef"
         style="overflow-y: auto; max-height: 72vh; padding-right: 4px;">
    @if (Messages.Any())
    {
        @foreach (var chatMessage in Messages)
        {
            <MudChat ChatPosition="@(chatMessage.Role == "user" ? ChatBubblePosition.End : ChatBubblePosition.Start)"
                     ArrowPosition="ChatArrowPosition.Top"
                     Class="mb-3">
                <MudChatBubble>
                    <MudText Typo="Typo.caption">@(chatMessage.Role == "user" ? "You" : "SmallEBot") Â· @chatMessage.CreatedAt.ToString("g")</MudText>
                    <MudText Typo="Typo.body1">@chatMessage.Content</MudText>
                </MudChatBubble>
            </MudChat>
        }
    }
    @* Optimistic user message: show immediately when sent, until parent refreshes with persisted messages *@
    @if (!string.IsNullOrEmpty(_pendingUserMessage))
    {
        <MudChat ChatPosition="ChatBubblePosition.End" ArrowPosition="ChatArrowPosition.Top" Class="mb-3">
            <MudChatBubble>
                <MudText Typo="Typo.caption">You Â· @_pendingUserMessageTime.ToString("g")</MudText>
                <MudText Typo="Typo.body1">@_pendingUserMessage</MudText>
            </MudChatBubble>
        </MudChat>
    }
    @if (_streaming)
    {
        <MudChat ChatPosition="ChatBubblePosition.Start" ArrowPosition="ChatArrowPosition.Top" Class="mb-3">
            <MudChatBubble>
                <MudText Typo="Typo.caption">SmallEBot Â· @DateTime.Now.ToString("g")</MudText>
                @foreach (var item in GetStreamingDisplayItems())
                {
                    if (item.IsText)
                    {
                        <MudText Typo="Typo.body1">@item.Text</MudText>
                    }
                    else if (ShowToolCalls)
                    {
                        <MudExpansionPanels Class="mt-2" Elevation="0">
                            <MudExpansionPanel expanded="false" title="@($"ðŸ”§ {item.ToolName ?? "Tool"}")">
                                <MudText Typo="Typo.body2"><strong>Tool:</strong> @(item.ToolName ?? "-")</MudText>
                                @if (!string.IsNullOrEmpty(item.ToolArguments))
                                {
                                    <MudText Typo="Typo.caption" Class="mt-1">Arguments: <pre class="d-inline">@item.ToolArguments</pre></MudText>
                                }
                                @if (!string.IsNullOrEmpty(item.ToolResult))
                                {
                                    <MudText Typo="Typo.caption" Class="mt-1">Result: <pre class="d-inline">@item.ToolResult</pre></MudText>
                                }
                            </MudExpansionPanel>
                        </MudExpansionPanels>
                    }
                }
                @if (!GetStreamingDisplayItems().Any() && !string.IsNullOrEmpty(_streamingText))
                {
                    <MudText Typo="Typo.body1">@_streamingText</MudText>
                }
            </MudChatBubble>
        </MudChat>
    }
    </div>

    <MudStack Row="true" Spacing="2" Class="mt-4">
        <MudTextField @bind-Value="_input"
                      Label="Message"
                      Variant="Variant.Outlined"
                      FullWidth="true"
                      Immediate="true"
                      OnKeyDown="@OnKeyDown" />
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   OnClick="@Send"
                   Disabled="@(_streaming || string.IsNullOrWhiteSpace(_input))">
            Send
        </MudButton>
    </MudStack>
</MudPaper>

@code {
    [Parameter] public List<ChatMessage> Messages { get; set; } = new();
    [Parameter] public Guid? ConversationId { get; set; }
    [Parameter] public string UserName { get; set; } = "";
    [Parameter] public EventCallback OnMessageSent { get; set; }
    [CascadingParameter(Name = "ShowToolCalls")] public bool ShowToolCalls { get; set; } = true;

    private ElementReference _chatScrollRef;
    private string _input = "";
    private bool _streaming;
    private string _streamingText = "";
    private List<StreamUpdate> _streamingUpdates = [];
    private string _pendingUserMessage = "";
    private DateTime _pendingUserMessageTime;
    private bool _scrollToBottomRequested;

    private async Task Send()
    {
        if (string.IsNullOrWhiteSpace(_input) || !ConversationId.HasValue) return;
        var msg = _input.Trim();
        _input = "";
        _pendingUserMessage = msg;
        _pendingUserMessageTime = DateTime.UtcNow;
        _streaming = true;
        _streamingText = "";
        _streamingUpdates.Clear();
        _scrollToBottomRequested = true;
        StateHasChanged();

        var persisted = false;
        try
        {
            var userName = UserNameSvc.CurrentDisplayName ?? UserName;
            if (string.IsNullOrWhiteSpace(userName))
            {
                Snackbar.Add("Username is missing. Please refresh and enter your name.", Severity.Warning);
                _pendingUserMessage = "";
                _streaming = false;
                await InvokeAsync(StateHasChanged);
                return;
            }
            await foreach (var update in AgentSvc.SendMessageStreamingAsync(ConversationId!.Value, msg))
            {
                switch (update)
                {
                    case TextStreamUpdate t:
                        _streamingText += t.Text;
                        _streamingUpdates.Add(update);
                        break;
                    case ToolCallStreamUpdate:
                        _streamingUpdates.Add(update);
                        break;
                    default:
                        break;
                }
                _scrollToBottomRequested = true;
                StateHasChanged();
            }
            await AgentSvc.PersistMessagesAsync(ConversationId!.Value, userName, msg, _streamingText);
            persisted = true;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            if (persisted)
            {
                await OnMessageSent.InvokeAsync();
                _pendingUserMessage = "";
            }
            _streaming = false;
            _scrollToBottomRequested = true;
            await InvokeAsync(StateHasChanged);
        }
    }

    protected override void OnParametersSet()
    {
        // Scroll to bottom when switching to another conversation
        if (ConversationId.HasValue && ConversationId != _lastConversationId)
        {
            _lastConversationId = ConversationId;
            if (Messages.Count > 0)
                _scrollToBottomRequested = true;
        }
    }

    private Guid? _lastConversationId;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_scrollToBottomRequested || _streaming)
        {
            _scrollToBottomRequested = false;
            try
            {
                await JS.InvokeVoidAsync("SmallEBot.scrollChatToBottom", _chatScrollRef);
            }
            catch { /* ignore if JS not loaded or disconnected */ }
        }
    }

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e is { Key: "Enter", ShiftKey: false }) await Send();
    }

    private sealed class StreamDisplayItem
    {
        public bool IsText { get; init; }
        public string? Text { get; init; }
        public string? ToolName { get; init; }
        public string? ToolArguments { get; init; }
        public string? ToolResult { get; set; }
    }

    private IEnumerable<StreamDisplayItem> GetStreamingDisplayItems()
    {
        var list = new List<StreamDisplayItem>();
        foreach (var update in _streamingUpdates)
        {
            if (update is TextStreamUpdate t)
            {
                list.Add(new StreamDisplayItem { IsText = true, Text = t.Text });
                continue;
            }
            if (update is ToolCallStreamUpdate tc)
            {
                if (tc.Result != null && tc.Arguments == null)
                {
                    var lastTool = list.LastOrDefault(x => !x.IsText);
                    if (lastTool != null)
                        lastTool.ToolResult = tc.Result;
                }
                else if (!string.IsNullOrEmpty(tc.ToolName) || tc.Arguments != null)
                {
                    list.Add(new StreamDisplayItem { IsText = false, ToolName = tc.ToolName, ToolArguments = tc.Arguments, ToolResult = tc.Result });
                }
            }
        }
        return list;
    }
}
