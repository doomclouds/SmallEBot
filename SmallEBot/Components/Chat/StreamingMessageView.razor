@* Streaming assistant message bubble: reasoning blocks, text segments, tool calls, and fallback text. *@
@using SmallEBot.Core.Models
<MudChat ChatPosition="ChatBubblePosition.Start" ArrowPosition="ChatArrowPosition.Top" Class="mb-3 smallebot-bubble">
    <MudChatBubble>
        <MudText Typo="Typo.caption">SmallEBot Â· @Timestamp.ToString("g")</MudText>
        @if (Items != null)
        {
            @foreach (var item in Items)
            {
                if (item is { IsReasoningBlock: true, Steps: { Count: > 0 } steps })
                {
                    var toolCount = steps.Count(x => !x.IsThink);
                    var panelTitle = toolCount > 0 ? $"ðŸ’­ Reasoning ({toolCount} tool calls)" : "ðŸ’­ Reasoning";
                    <MudExpansionPanels Class="mt-2" Elevation="0">
                        <MudExpansionPanel expanded="false" Text="@panelTitle">
                            <div class="d-flex flex-column gap-2">
                                <ReasoningBlockView Steps="@steps" />
                            </div>
                        </MudExpansionPanel>
                    </MudExpansionPanels>
                }
                else if (item.IsText)
                {
                    <MarkdownContentView Content="@item.Text" />
                }
                else if (item.IsReplyTool && ShowToolCalls)
                {
                    <ToolCallView ToolName="@item.ToolName"
                                  ToolArguments="@item.ToolArguments"
                                  ToolResult="@item.ToolResult"
                                  Phase="@item.Phase"
                                  Elapsed="@item.Elapsed"
                                  ShowToolCalls="@ShowToolCalls"
                                  OnCancel="@(CanShowCancel(item.Phase) ? OnCancel : EventCallback.Empty)" />
                }
            }
        }
        @if (ShowFallbackText)
        {
            <MarkdownContentView Content="@FallbackText" />
        }
    </MudChatBubble>
</MudChat>

@code {
    [Parameter] public IReadOnlyList<StreamingDisplayItemView>? Items { get; set; }
    [Parameter] public string? FallbackText { get; set; }
    [Parameter] public DateTime Timestamp { get; set; } = DateTime.Now;
    [Parameter] public EventCallback OnCancel { get; set; }
    [CascadingParameter(Name = "ShowToolCalls")] public bool ShowToolCalls { get; set; } = true;

    private bool ShowFallbackText => (Items is null || Items.Count == 0) && !string.IsNullOrEmpty(FallbackText);

    private static bool CanShowCancel(ToolCallPhase phase) =>
        phase is ToolCallPhase.Started or ToolCallPhase.ArgsReceived or ToolCallPhase.Executing;
}
