@inherits LayoutComponentBase
@inject UserNameService UserNameSvc
@inject IJSRuntime JS

<MudThemeProvider Theme="@(ThemeProviderHelper.GetMudTheme(_currentThemeId))" IsDarkMode="@(ThemeProviderHelper.IsDarkModeForTheme(_currentThemeId))" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<MudLayout Class="smallebot-layout">
    <MudAppBar Elevation="0" Class="smallebot-appbar">
        <MudText Typo="Typo.h6" Class="smallebot-logo">SmallEBot</MudText>
        <MudSpacer />
        <MudTooltip Text="主题">
            <MudMenu Icon="@Icons.Material.Filled.Palette"
                     AnchorOrigin="Origin.BottomRight"
                     TransformOrigin="Origin.TopRight"
                     Color="Color.Default">
                @foreach (var id in ThemeConstants.ThemeIds)
                {
                    var idCopy = id;
                    <MudMenuItem OnClick="@(() => SelectTheme(idCopy))">
                        @GetThemeLabel(id) @(_currentThemeId == id ? "✓" : "")
                    </MudMenuItem>
                }
            </MudMenu>
        </MudTooltip>
        <MudTooltip Text="@(_showToolCalls ? "隐藏工具调用" : "显示工具调用")">
            <MudIconButton Icon="@Icons.Material.Filled.Build"
                           Color="@(_showToolCalls ? Color.Primary : Color.Default)"
                           OnClick="@ToggleShowToolCalls" />
        </MudTooltip>
        <MudSwitch @bind-Value="_showToolCalls" Color="Color.Primary" Class="ms-2">
            <MudText Typo="Typo.body2">工具调用</MudText>
        </MudSwitch>
        <MudTooltip Text="@(_useThinkingMode ? "关闭思考模式" : "开启思考模式")">
            <MudIconButton Icon="@Icons.Material.Filled.Psychology"
                           Color="@(_useThinkingMode ? Color.Primary : Color.Default)"
                           OnClick="@ToggleUseThinkingMode" />
        </MudTooltip>
        <MudSwitch @bind-Value="_useThinkingMode" Color="Color.Primary" Class="ms-2">
            <MudText Typo="Typo.body2">思考</MudText>
        </MudSwitch>
        @if (!string.IsNullOrEmpty(UserNameSvc.CurrentDisplayName))
        {
            <MudText Typo="Typo.body2" Class="smallebot-username">@UserNameSvc.CurrentDisplayName</MudText>
        }
    </MudAppBar>
    <MudMainContent Class="smallebot-main">
        <CascadingValue Value="_showToolCalls" Name="ShowToolCalls">
            <CascadingValue Value="_useThinkingMode" Name="UseThinkingMode">
                @Body
            </CascadingValue>
        </CascadingValue>
    </MudMainContent>
</MudLayout>

@code {
    private string _currentThemeId = ThemeConstants.DefaultThemeId;
    private bool _showToolCalls = true;
    private bool _useThinkingMode = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var id = await JS.InvokeAsync<string>("SmallEBotGetTheme");
                _currentThemeId = ThemeConstants.NormalizeThemeId(id);
                await InvokeAsync(StateHasChanged);
            }
            catch
            {
                /* keep default */
            }
        }
    }

    private async Task SelectTheme(string id)
    {
        _currentThemeId = ThemeConstants.NormalizeThemeId(id);
        try
        {
            await JS.InvokeVoidAsync("SmallEBotSetTheme", id);
        }
        catch
        {
            /* ignore */
        }

        StateHasChanged();
    }

    private static string GetThemeLabel(string id) => id switch
    {
        "editorial-dark" => "编辑深色",
        "paper-light" => "纸感浅色",
        "terminal" => "终端",
        "dusk" => "暮色",
        "mono" => "单色",
        _ => id
    };

    private void ToggleShowToolCalls()
    {
        _showToolCalls = !_showToolCalls;
        StateHasChanged();
    }

    private void ToggleUseThinkingMode()
    {
        _useThinkingMode = !_useThinkingMode;
        StateHasChanged();
    }
}
