@inherits LayoutComponentBase
@using SmallEBot.Components.Mcp
@implements IDisposable
@inject UserNameService UserNameSvc
@inject UserPreferencesService Preferences
@inject IDialogService DialogService
@inject IJSRuntime JS

<MudThemeProvider Theme="@(ThemeProviderHelper.GetMudTheme(_currentThemeId))" IsDarkMode="@(ThemeProviderHelper.IsDarkModeForTheme(_currentThemeId))" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<MudLayout Class="smallebot-layout">
    <MudAppBar Elevation="0" Class="smallebot-appbar">
        <MudText Typo="Typo.h6" Class="smallebot-logo">SmallEBot</MudText>
        <MudSpacer />
        <MudTooltip Text="Theme">
            <MudMenu Icon="@Icons.Material.Filled.Palette"
                     AnchorOrigin="Origin.BottomRight"
                     TransformOrigin="Origin.TopRight"
                     Color="Color.Default">
                @foreach (var id in ThemeConstants.ThemeIds)
                {
                    var idCopy = id;
                    <MudMenuItem OnClick="@(() => SelectTheme(idCopy))">
                        @GetThemeLabel(id) @(_currentThemeId == id ? "âœ“" : "")
                    </MudMenuItem>
                }
            </MudMenu>
        </MudTooltip>
        <MudTooltip Text="@(_showToolCalls ? "Hide tool calls" : "Show tool calls")">
            <MudIconButton Icon="@Icons.Material.Filled.Build"
                           Color="@(_showToolCalls ? Color.Primary : Color.Default)"
                           OnClick="@ToggleShowToolCalls" />
        </MudTooltip>
        <MudTooltip Text="@(_useThinkingMode ? "Disable thinking mode" : "Enable thinking mode")">
            <MudIconButton Icon="@Icons.Material.Filled.Psychology"
                           Color="@(_useThinkingMode ? Color.Primary : Color.Default)"
                           OnClick="@ToggleUseThinkingMode" />
        </MudTooltip>
        <MudTooltip Text="MCP config">
            <MudIconButton Icon="@Icons.Material.Filled.Extension"
                           Color="Color.Default"
                           OnClick="@OpenMcpConfig" />
        </MudTooltip>
        <MudTooltip Text="Skills config">
            <MudIconButton Icon="@Icons.Material.Filled.School"
                           Color="Color.Default"
                           OnClick="@OpenSkillsConfig" />
        </MudTooltip>
        <MudText Typo="Typo.body2" Class="smallebot-username">@UserNameSvc.CurrentDisplayName</MudText>
    </MudAppBar>
    <MudMainContent Class="smallebot-main">
        <CascadingValue Value="_showToolCalls" Name="ShowToolCalls">
            <CascadingValue Value="_useThinkingMode" Name="UseThinkingMode">
                @Body
            </CascadingValue>
        </CascadingValue>
    </MudMainContent>
</MudLayout>

@code {
    private string _currentThemeId = ThemeConstants.DefaultThemeId;
    private bool _showToolCalls = true;
    private bool _useThinkingMode;
    private string? _userName;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var prefs = await Preferences.LoadAsync();
                _currentThemeId = ThemeConstants.NormalizeThemeId(prefs.Theme);
                _showToolCalls = prefs.ShowToolCalls;
                _useThinkingMode = prefs.UseThinkingMode;
                await JS.InvokeVoidAsync("SmallEBotSetTheme", _currentThemeId);
                await InvokeAsync(StateHasChanged);
            }
            catch
            {
                try
                {
                    var id = await JS.InvokeAsync<string>("SmallEBotGetTheme");
                    _currentThemeId = ThemeConstants.NormalizeThemeId(id);
                }
                catch
                {
                    /* keep default */
                }
            }
        }

        if (string.IsNullOrEmpty(_userName))
            _userName = await UserNameSvc.GetAsync();
    }

    private async Task SelectTheme(string id)
    {
        _currentThemeId = ThemeConstants.NormalizeThemeId(id);
        try
        {
            await JS.InvokeVoidAsync("SmallEBotSetTheme", _currentThemeId);
            await Preferences.SetThemeAsync(_currentThemeId);
        }
        catch
        {
            /* ignore */
        }

        StateHasChanged();
    }

    private static string GetThemeLabel(string id) => id switch
    {
        "editorial-dark" => "Editorial dark",
        "paper-light" => "Paper light",
        "terminal" => "Terminal",
        "dusk" => "Dusk",
        "mono" => "Mono",
        _ => id
    };

    private async Task ToggleShowToolCalls()
    {
        _showToolCalls = !_showToolCalls;
        try { await Preferences.SetShowToolCallsAsync(_showToolCalls); }
        catch { /* ignore */ }
        StateHasChanged();
    }

    private async Task ToggleUseThinkingMode()
    {
        _useThinkingMode = !_useThinkingMode;
        try { await Preferences.SetUseThinkingModeAsync(_useThinkingMode); }
        catch { /* ignore */ }
        StateHasChanged();
    }

    private void OpenMcpConfig() =>
        DialogService.ShowAsync<McpConfigDialog>(string.Empty, new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true });

    private void OpenSkillsConfig() =>
        DialogService.ShowAsync<SkillsConfigDialog>(string.Empty, new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true });

    protected override void OnInitialized()
    {
        UserNameSvc.UsernameChanged += OnUsernameChanged;
    }

    private void OnUsernameChanged()
    {
        _ = InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        UserNameSvc.UsernameChanged -= OnUsernameChanged;
    }
}
