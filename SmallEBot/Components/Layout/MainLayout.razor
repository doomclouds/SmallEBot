@inherits LayoutComponentBase
@using SmallEBot.Components.Agent
@using SmallEBot.Components.Settings
@using SmallEBot.Components.TaskList
@implements IDisposable
@inject UserNameService UserNameSvc
@inject UserPreferencesService Preferences
@inject IDialogService DialogService
@inject IJSRuntime JS

<MudThemeProvider Theme="@(ThemeProviderHelper.GetMudTheme(_currentThemeId))" IsDarkMode="@(ThemeProviderHelper.IsDarkModeForTheme(_currentThemeId))" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<MudLayout Class="smallebot-layout">
    <MudAppBar Elevation="0" Class="smallebot-appbar">
        <MudText Typo="Typo.h6" Class="smallebot-logo">SmallEBot</MudText>
        <MudSpacer />
        <MudTooltip Text="Model">
            <ModelSelectorMenu OnManageModels="@OpenModelSettings" />
        </MudTooltip>
        <MudTooltip Text="Settings (Theme, MCP, Skills, Terminal)">
            <MudIconButton Icon="@Icons.Material.Filled.Settings"
                           Color="Color.Default"
                           OnClick="@OpenSettings" />
        </MudTooltip>
        <MudTooltip Text="@(_showToolCalls ? "Hide tool calls" : "Show tool calls")">
            <MudIconButton Icon="@Icons.Material.Filled.Build"
                           Color="@(_showToolCalls ? Color.Primary : Color.Default)"
                           OnClick="@ToggleShowToolCalls" />
        </MudTooltip>
        <MudTooltip Text="@(_useThinkingMode ? "Disable thinking mode" : "Enable thinking mode")">
            <MudIconButton Icon="@Icons.Material.Filled.Psychology"
                           Color="@(_useThinkingMode ? Color.Primary : Color.Default)"
                           OnClick="@ToggleUseThinkingMode" />
        </MudTooltip>
        <MudTooltip Text="Workspace">
            <MudIconButton Icon="@Icons.Material.Filled.Folder"
                           Color="@(_workspaceDrawerOpen ? Color.Primary : Color.Default)"
                           OnClick="@ToggleWorkspaceDrawer" />
        </MudTooltip>
        <MudTooltip Text="Task list">
            <MudIconButton Icon="@Icons.Material.Filled.TaskAlt"
                           Color="@(_taskListDrawerOpen ? Color.Primary : Color.Default)"
                           OnClick="@ToggleTaskListDrawer" />
        </MudTooltip>
        <MudText Typo="Typo.body2" Class="smallebot-username">@UserNameSvc.CurrentDisplayName</MudText>
    </MudAppBar>
    <MudMainContent Class="smallebot-main">
        <div class="smallebot-main-with-drawer">
            <div class="smallebot-main-body">
                <CascadingValue Value="_showToolCalls" Name="ShowToolCalls">
                    <CascadingValue Value="_useThinkingMode" Name="UseThinkingMode">
                        @Body
                    </CascadingValue>
                </CascadingValue>
            </div>
            @if (_workspaceDrawerOpen)
            {
                <div class="smallebot-workspace-drawer-panel">
                    <WorkspaceDrawer Open="_workspaceDrawerOpen" OnClose="@CloseWorkspaceDrawer" />
                </div>
            }
            @if (_taskListDrawerOpen)
            {
                <div class="smallebot-workspace-drawer-panel">
                    <TaskListDrawer Open="_taskListDrawerOpen" OnClose="@CloseTaskListDrawer" />
                </div>
            }
        </div>
    </MudMainContent>
    <CommandConfirmationStrip />
</MudLayout>

@code {
    private string _currentThemeId = ThemeConstants.DefaultThemeId;
    private bool _showToolCalls = true;
    private bool _useThinkingMode;
    private bool _workspaceDrawerOpen;
    private bool _taskListDrawerOpen;
    private string? _userName;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var prefs = await Preferences.LoadAsync();
                _currentThemeId = ThemeConstants.NormalizeThemeId(prefs.Theme);
                _showToolCalls = prefs.ShowToolCalls;
                _useThinkingMode = prefs.UseThinkingMode;
                await JS.InvokeVoidAsync("SmallEBotSetTheme", _currentThemeId);
                await InvokeAsync(StateHasChanged);
            }
            catch
            {
                try
                {
                    var id = await JS.InvokeAsync<string>("SmallEBotGetTheme");
                    _currentThemeId = ThemeConstants.NormalizeThemeId(id);
                }
                catch
                {
                    /* keep default */
                }
            }
        }

        if (string.IsNullOrEmpty(_userName))
            _userName = await UserNameSvc.GetAsync();
    }

    private async Task ToggleShowToolCalls()
    {
        _showToolCalls = !_showToolCalls;
        try { await Preferences.SetShowToolCallsAsync(_showToolCalls); }
        catch { /* ignore */ }
        StateHasChanged();
    }

    private async Task ToggleUseThinkingMode()
    {
        _useThinkingMode = !_useThinkingMode;
        try { await Preferences.SetUseThinkingModeAsync(_useThinkingMode); }
        catch { /* ignore */ }
        StateHasChanged();
    }

    private void OpenModelSettings() =>
        DialogService.ShowAsync<ModelConfigDialog>(string.Empty, new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true });

    private void OpenSettings()
    {
        var parameters = new DialogParameters
        {
            [nameof(SettingsDialog.CurrentThemeId)] = _currentThemeId,
            [nameof(SettingsDialog.OnThemeChanged)] = EventCallback.Factory.Create<string>(this, OnThemeChangedFromSettings)
        };
        DialogService.ShowAsync<SettingsDialog>("Settings", parameters, new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true });
    }

    private void OnThemeChangedFromSettings(string id)
    {
        _currentThemeId = ThemeConstants.NormalizeThemeId(id);
        StateHasChanged();
    }

    private void ToggleWorkspaceDrawer() => _workspaceDrawerOpen = !_workspaceDrawerOpen;

    private void CloseWorkspaceDrawer() => _workspaceDrawerOpen = false;

    private void ToggleTaskListDrawer() => _taskListDrawerOpen = !_taskListDrawerOpen;

    private void CloseTaskListDrawer() => _taskListDrawerOpen = false;

    protected override void OnInitialized()
    {
        UserNameSvc.UsernameChanged += OnUsernameChanged;
    }

    private void OnUsernameChanged()
    {
        _ = InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        UserNameSvc.UsernameChanged -= OnUsernameChanged;
    }
}
