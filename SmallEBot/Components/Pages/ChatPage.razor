@page "/"
@layout MainLayout
@using SmallEBot.Core.Entities
@inject UserNameService UserNameSvc
@inject ConversationService ConvSvc
@inject IDialogService DialogSvc
@inject ICurrentConversationService CurrentConversation

@if (string.IsNullOrEmpty(_userName))
{
    <div class="smallebot-chat-page"><p class="smallebot-empty-state">Loading...</p></div>
}
else
{
    <MudLayout>
        <ConversationSidebar Conversations="_conversations"
                             UserName="_userName"
                             SelectedId="_selectedId"
                             SearchQuery="@_searchQuery"
                             OnSelect="@OnSelectConversation"
                             OnCreate="@OnCreateConversation"
                             OnDelete="@OnDeleteConversation"
                             OnSearchQueryChanged="@OnSearchQueryChanged"
                             Open="true" />
        <MudMainContent Class="smallebot-main">
            @if (_selectedConversation != null)
            {
                <div class="smallebot-chat-page">
                    <div class="smallebot-chat-outer">
                        <ChatArea Bubbles="@(ConversationService.GetChatBubbles(_selectedConversation!))"
                                  ConversationId="_selectedConversation.Id"
                                  UserName="_userName"
                                  OnMessageSent="@RefreshSidebar"
                                  OnBeforeSend="@RefreshCurrentConversation" />
                    </div>
                </div>
            }
            else
            {
                <div class="smallebot-chat-page">
                    <p class="smallebot-empty-state">Select or create a conversation to start chatting.</p>
                </div>
            }
        </MudMainContent>
    </MudLayout>
}

@code {
    private string? _userName;
    private Guid? _selectedId;
    private Conversation? _selectedConversation;
    private List<Conversation> _conversations = [];
    private string? _searchQuery;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        // Run after circuit is established - ProtectedSessionStorage and dialogs require interactive context
        _userName = await UserNameSvc.GetAsync();
        if (string.IsNullOrEmpty(_userName))
        {
            var dialog = await DialogSvc.ShowAsync<UserNameDialog>("Welcome");
            var result = await dialog.Result;
            if (result == null || result.Canceled || result.Data == null || string.IsNullOrWhiteSpace(result.Data as string))
                return;
            _userName = (result.Data as string)!.Trim();
            await UserNameSvc.SetAsync(_userName);
        }
        await LoadConversations();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadConversations()
    {
        if (string.IsNullOrEmpty(_userName)) return;
        _conversations = string.IsNullOrWhiteSpace(_searchQuery)
            ? await ConvSvc.GetListAsync(_userName)
            : await ConvSvc.SearchAsync(_userName, _searchQuery.Trim());
        if (_conversations.Count > 0 && !_selectedId.HasValue)
            await OnSelectConversation(_conversations[0].Id);
    }

    private async Task OnSearchQueryChanged(string? query)
    {
        _searchQuery = string.IsNullOrWhiteSpace(query) ? null : query;
        await LoadConversations();
    }

    private async Task OnSelectConversation(Guid id)
    {
        _selectedId = id;
        _selectedConversation = await ConvSvc.GetByIdAsync(id, _userName!);
        CurrentConversation.SetCurrentConversationId(id);
        StateHasChanged();
    }

    private async Task OnCreateConversation()
    {
        _searchQuery = null;
        var c = await ConvSvc.CreateAsync(_userName!);
        await LoadConversations();
        _selectedId = c.Id;
        _selectedConversation = c;
        CurrentConversation.SetCurrentConversationId(c.Id);
        StateHasChanged();
    }

    private async Task OnDeleteConversation(Guid id)
    {
        if (_selectedId == id)
        {
            _selectedId = null;
            _selectedConversation = null;
            CurrentConversation.SetCurrentConversationId(null);
        }
        await LoadConversations();
    }

    private async Task RefreshSidebar()
    {
        _conversations = string.IsNullOrWhiteSpace(_searchQuery)
            ? await ConvSvc.GetListAsync(_userName!)
            : await ConvSvc.SearchAsync(_userName!, _searchQuery.Trim());
        if (_selectedId.HasValue)
            _selectedConversation = await ConvSvc.GetByIdAsync(_selectedId.Value, _userName!);
        await InvokeAsync(StateHasChanged);
    }

    /// <summary>Refetch current conversation (e.g. before sending so display includes last persisted reply).</summary>
    private async Task RefreshCurrentConversation()
    {
        if (_selectedId.HasValue && !string.IsNullOrEmpty(_userName))
        {
            _selectedConversation = await ConvSvc.GetByIdAsync(_selectedId.Value, _userName);
            await InvokeAsync(StateHasChanged);
        }
    }
}
