@using System.IO
@implements IDisposable
@inject IWorkspaceService WorkspaceService
@inject IDialogService DialogService

<div class="workspace-drawer">
    <div class="workspace-drawer-header">
        <MudText Typo="Typo.h6">Workspace</MudText>
        <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="@(() => OnClose.InvokeAsync())" />
    </div>
    <div class="workspace-drawer-tree">
        @if (_tree == null)
        {
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Small" />
        }
        else if (_tree.Count == 0)
        {
            <MudText Typo="Typo.body2" Class="pa-2">Workspace is empty</MudText>
        }
        else
        {
            <div class="workspace-tree-root">
                @foreach (var node in _tree)
                {
                    <WorkspaceTreeItem Node="@node" OnFileSelected="@(path => SelectFile(path))" OnDeleteRequested="@ShowDeleteConfirmAsync" />
                }
            </div>
        }
    </div>
    <MudDivider />
    <div class="workspace-drawer-viewer">
        @if (!string.IsNullOrEmpty(_selectedPath))
        {
            <MudText Typo="Typo.caption" Class="pa-2">@_selectedPath</MudText>
            @if (_viewerContent == null && _viewerLoaded)
            {
                <MudText Typo="Typo.body2" Class="pa-2">Binary or too large to display.</MudText>
            }
            else if (_viewerContent != null)
            {
                <pre class="workspace-viewer-pre">@_viewerContent</pre>
            }
        }
        else
        {
            <MudText Typo="Typo.body2" Class="pa-2">Select a file to view content.</MudText>
        }
    </div>
</div>

@code {
    private const int PollIntervalMs = 2000;

    [Parameter] public bool Open { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private IReadOnlyList<WorkspaceNode>? _tree;
    private string? _selectedPath;
    private string? _viewerContent;
    private bool _viewerLoaded;
    private CancellationTokenSource? _pollCts;

    protected override async Task OnParametersSetAsync()
    {
        if (Open)
        {
            await LoadTreeAsync();
            StartPolling();
        }
        else
            StopPolling();
    }

    public async Task LoadTreeAsync()
    {
        _tree = await WorkspaceService.GetTreeAsync();
        StateHasChanged();
    }

    private async Task SelectFile(string relativePath)
    {
        _selectedPath = relativePath;
        _viewerContent = null;
        _viewerLoaded = false;
        StateHasChanged();
        _viewerContent = await WorkspaceService.ReadFileContentAsync(relativePath);
        _viewerLoaded = true;
        StateHasChanged();
    }

    private async Task ShowDeleteConfirmAsync(string relativePath)
    {
        var name = Path.GetFileName(relativePath);
        var parameters = new DialogParameters
        {
            [nameof(DeleteWorkspaceConfirmDialog.RelativePath)] = relativePath,
            [nameof(DeleteWorkspaceConfirmDialog.Name)] = name,
            [nameof(DeleteWorkspaceConfirmDialog.IsDirectory)] = false
        };
        var dialog = await DialogService.ShowAsync<DeleteWorkspaceConfirmDialog>("Delete", parameters);
        var result = await dialog.Result;
        if (result != null && !result.Canceled)
            await LoadTreeAsync();
    }

    private void StartPolling()
    {
        if (_pollCts != null) return;
        _pollCts = new CancellationTokenSource();
        var token = _pollCts.Token;
        _ = Task.Run(async () =>
        {
            using var timer = new PeriodicTimer(TimeSpan.FromMilliseconds(PollIntervalMs));
            try
            {
                while (await timer.WaitForNextTickAsync(token))
                {
                    await InvokeAsync(async () =>
                    {
                        if (!Open) return;
                        await LoadTreeAsync();
                        if (!string.IsNullOrEmpty(_selectedPath))
                        {
                            var newContent = await WorkspaceService.ReadFileContentAsync(_selectedPath, token);
                            _viewerContent = newContent;
                        }
                        StateHasChanged();
                    });
                }
            }
            catch (OperationCanceledException) { }
        }, token);
    }

    private void StopPolling()
    {
        _pollCts?.Cancel();
        _pollCts?.Dispose();
        _pollCts = null;
    }

    public void Dispose() => StopPolling();
}
