@using System.IO
@implements IDisposable
@inject IWorkspaceService WorkspaceService
@inject IWorkspaceWatcher WorkspaceWatcher
@inject IDialogService DialogService

<div class="workspace-drawer">
    <div class="workspace-drawer-header">
        <MudText Typo="Typo.h6">Workspace</MudText>
        <MudIconButton Icon="@Icons.Material.Filled.Close" OnClick="@(() => OnClose.InvokeAsync())" />
    </div>
    <div class="workspace-drawer-tree">
        @if (_tree == null)
        {
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Small" />
        }
        else if (_tree.Count == 0)
        {
            <MudText Typo="Typo.body2" Class="pa-2">Workspace is empty</MudText>
        }
        else
        {
            <div class="workspace-tree-root">
                @foreach (var node in _tree)
                {
                    <WorkspaceTreeItem Node="@node" OnFileSelected="@(path => SelectFile(path))" OnDeleteRequested="@ShowDeleteConfirmAsync" />
                }
            </div>
        }
    </div>
    <MudDivider />
    <div class="workspace-drawer-viewer">
        @if (!string.IsNullOrEmpty(_selectedPath))
        {
            <MudText Typo="Typo.caption" Class="pa-2">@_selectedPath</MudText>
            @if (_viewerContent == null && _viewerLoaded)
            {
                <MudText Typo="Typo.body2" Class="pa-2">Binary or too large to display.</MudText>
            }
            else if (_viewerContent != null)
            {
                <pre class="workspace-viewer-pre">@_viewerContent</pre>
            }
        }
        else
        {
            <MudText Typo="Typo.body2" Class="pa-2">Select a file to view content.</MudText>
        }
    </div>
</div>

@code {
    [Parameter] public bool Open { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private IReadOnlyList<WorkspaceNode>? _tree;
    private string? _selectedPath;
    private string? _viewerContent;
    private bool _viewerLoaded;

    protected override async Task OnParametersSetAsync()
    {
        if (Open)
        {
            await LoadTreeAsync();
            SubscribeToChanges();
        }
        else
        {
            UnsubscribeFromChanges();
        }
    }

    public async Task LoadTreeAsync()
    {
        _tree = await WorkspaceService.GetTreeAsync();
        StateHasChanged();
    }

    private void SubscribeToChanges()
    {
        WorkspaceWatcher.OnChange += HandleChange;
        WorkspaceWatcher.Start();
    }

    private void UnsubscribeFromChanges()
    {
        WorkspaceWatcher.OnChange -= HandleChange;
        WorkspaceWatcher.Stop();
    }

    private async void HandleChange(WorkspaceChangeEvent e)
    {
        await InvokeAsync(async () =>
        {
            await LoadTreeAsync();
            if (!string.IsNullOrEmpty(_selectedPath) &&
                (e.RelativePath == _selectedPath ||
                 _selectedPath.StartsWith(e.RelativePath + "/", StringComparison.Ordinal)))
            {
                _viewerContent = await WorkspaceService.ReadFileContentAsync(_selectedPath);
            }
            StateHasChanged();
        });
    }

    private async Task SelectFile(string relativePath)
    {
        _selectedPath = relativePath;
        _viewerContent = null;
        _viewerLoaded = false;
        StateHasChanged();
        _viewerContent = await WorkspaceService.ReadFileContentAsync(relativePath);
        _viewerLoaded = true;
        StateHasChanged();
    }

    private async Task ShowDeleteConfirmAsync(string relativePath)
    {
        var name = Path.GetFileName(relativePath);
        var parameters = new DialogParameters
        {
            [nameof(DeleteWorkspaceConfirmDialog.RelativePath)] = relativePath,
            [nameof(DeleteWorkspaceConfirmDialog.Name)] = name,
            [nameof(DeleteWorkspaceConfirmDialog.IsDirectory)] = false
        };
        var dialog = await DialogService.ShowAsync<DeleteWorkspaceConfirmDialog>("Delete", parameters);
        var result = await dialog.Result;
        if (result != null && !result.Canceled)
            await LoadTreeAsync();
    }

    public void Dispose() => UnsubscribeFromChanges();
}
